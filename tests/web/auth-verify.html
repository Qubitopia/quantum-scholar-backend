<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuantumScholar â€” Verify New User</title>
  <style>body{font-family:Arial,Helvetica,sans-serif;margin:24px}input{padding:8px;width:420px}button{padding:8px 12px;margin-top:8px}pre{background:#f7f7f7;padding:12px;border-radius:6px}</style>
</head>
<body>
  <h1>Verify new user</h1>
  <p>This page accepts a verification token via the query string <code>?token=...</code> or via the input below, then calls your backend verify route to exchange it for a JWT and saves the JWT to <code>localStorage.qs_token</code>.</p>

  <div>
    <label>Token (from email link)
      <input id="tokenInput" placeholder="paste token here or open with ?token=..." />
    </label>
    <div>
      <button id="verifyBtn">Verify token</button>
      <button id="goProfile" style="margin-left:8px;">Open Profile</button>
    </div>
  </div>

  <h3>Status</h3>
  <pre id="out">Waiting for action...</pre>

  <script>
    const API_BASE = 'http://localhost:8000'
    const out = document.getElementById('out')
    const tokenInput = document.getElementById('tokenInput')
    const params = new URLSearchParams(window.location.search)
    const qToken = params.get('token')
    if(qToken){ tokenInput.value = qToken; out.textContent = 'Token found in URL, ready to verify.' }

    async function doVerify(token){
      if(!token){ out.textContent = 'No token provided'; return }
      out.textContent = 'Verifying token with API...'
      try{
        const res = await fetch(API_BASE + '/auth/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        })
        const data = await res.json()
        out.textContent = 'Response:\n' + JSON.stringify(data, null, 2)

        // heuristics: find a jwt/token in the response
        const jwt = data.token || data.jwt || data.access_token || data.auth_token || data.session_token || (data.data && (data.data.token || data.data.jwt))
        if(jwt){
          localStorage.setItem('qs_token', jwt)
          out.textContent += '\n\nSaved JWT to localStorage key: qs_token'
          // optional redirect to the profile page on the same static server
          out.textContent += '\nRedirecting to profile.html in 2s...'
          setTimeout(()=>{ window.location.href = '/profile.html' }, 2000)
        } else {
          out.textContent += '\n\nNo JWT/token found in response. Check the API contract or inspect the response above.'
        }
      }catch(err){ out.textContent = 'Verify error: ' + err.message }
    }

    document.getElementById('verifyBtn').addEventListener('click', ()=> doVerify(tokenInput.value.trim()))
    document.getElementById('goProfile').addEventListener('click', ()=> window.location.href = '/profile.html')

    // Auto-run if token present in querystring
    if(qToken){ doVerify(qToken) }
  </script>
</body>
</html>
