<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuantumScholar — Purchase QS Coins (INR)</title>
  <style>body{font-family:Arial,Helvetica,sans-serif;margin:24px}label{display:block;margin-top:8px}input{padding:8px;width:200px}button{margin-top:12px;padding:8px 12px}pre{background:#f7f7f7;padding:12px;border-radius:6px}</style>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
  <h1>Purchase QS Coins (INR)</h1>
  <p>This page demonstrates the frontend portion of the Razorpay flow:
  1) POST to <code>/api/purchase-qscoins-inr</code> to create an order.
  2) Use Razorpay Checkout (client) with the returned order id to open payment UI.
  3) On success, POST to <code>/api/verify-razorpay-payment</code> with the razorpay ids & signature to let the backend verify and credit coins.
  </p>

  <label>Razorpay Key ID (publishable) — for demo only
    <input id="rzp_key" placeholder="rzp_live_... or rzp_test_..." />
  </label>

  <form id="purchaseForm">
    <label>QS Coins to buy (integer)
      <input id="qscoins" type="number" min="1" value="10" />
    </label>
    <button type="submit">Create Order & Pay</button>
  </form>

  <pre id="out">Ready.</pre>

  <script>
    const API_BASE = 'http://localhost:8000'
    const out = document.getElementById('out')
    const token = () => localStorage.getItem('qs_token')

    document.getElementById('purchaseForm').addEventListener('submit', async (e)=>{
      e.preventDefault()
      const qscoins = Number(document.getElementById('qscoins').value)
      if(!qscoins || qscoins < 1) { out.textContent = 'Enter a valid amount'; return }

      out.textContent = 'Creating order...'
      try{
  const res = await fetch(API_BASE + '/api/purchase-qscoins-inr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token() },
          body: JSON.stringify({ qscoins })
        })
        const data = await res.json()
        out.textContent = 'Order response:\n' + JSON.stringify(data, null, 2)

        // Razorpay checkout requires the publishable key and the order id created by Razorpay (server should return it)
        const rzpKey = document.getElementById('rzp_key').value.trim()
        if(!rzpKey){ out.textContent += '\n\nEnter your Razorpay Key ID to open Checkout (for testing you can use test keys)'; return }

        const options = {
          key: rzpKey,
          amount: (data.amount || 0) * 100, // amount in paise; backend already sent paise in our server but keep safe
          currency: data.currency || 'INR',
          name: 'QuantumScholar',
          description: 'QS Coins purchase',
          order_id: data.razorpay_order_id, // NOTE: server used payment.RazorpayOrderID to store order id
          // If your server returned a different field (like order.id), adjust accordingly
          handler: async function (response){
            out.textContent = 'Payment succeeded, verifying with server...'
            // response contains razorpay_payment_id, razorpay_order_id, razorpay_signature
            try{
              const verifyRes = await fetch(API_BASE + '/api/verify-razorpay-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token() },
                body: JSON.stringify({ razorpay_order_id: response.razorpay_order_id, razorpay_payment_id: response.razorpay_payment_id, razorpay_signature: response.razorpay_signature })
              })
              const verifyData = await verifyRes.json()
              out.textContent = 'Verification result:\n' + JSON.stringify(verifyData, null, 2)
            }catch(err){ out.textContent = 'Verification error: ' + err.message }
          },
          prefill: { email: '', name: '' },
          theme: { color: '#2e6da4' }
        }

        const rzp = new Razorpay(options)
        rzp.open()

      }catch(err){ out.textContent = 'Error: ' + err.message }
    })
  </script>
</body>
</html>
